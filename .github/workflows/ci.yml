name: Build StripperCS2

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        include:
          - os: ubuntu-latest
            target: linux64
            artifact_name: libStripperCS2.so
          - os: windows-latest
            target: win64
            artifact_name: StripperCS2.dll

    steps:
      - name: Checkout StripperCS2
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 修复：手动下载 Premake5
      - name: Download Premake5
        run: |
          if [ "${{ runner.os }}" == "Linux" ]; then
            wget -q https://github.com/premake/premake-core/releases/download/v5.0.0-beta2/premake-5.0.0-beta2-linux.tar.gz
            tar -xzf premake-5.0.0-beta2-linux.tar.gz
            chmod +x premake5
            sudo mv premake5 /usr/local/bin/
          else
            curl -L -o premake5.zip https://github.com/premake/premake-core/releases/download/v5.0.0-beta2/premake-5.0.0-beta2-windows.zip
            unzip -q -o premake5.zip
            mkdir -p C:/tools/premake5
            move premake5.exe C:/tools/premake5/
            echo "C:/tools/premake5" >> $GITHUB_PATH
          fi

      - name: Verify Premake5
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
            C:/tools/premake5/premake5.exe --version
          else
            premake5 --version
          fi

      # 修复：克隆 Metamod-Source（使用正确的仓库）
      - name: Clone Metamod-Source
        run: |
          git clone --branch master --depth 1 --recursive https://github.com/alliedmodders/metamod-source.git mmsource-2.0

      # 修复：克隆 HL2SDK
      - name: Clone HL2SDK
        run: |
          git clone --branch cs2 --depth 1 https://github.com/alliedmodders/hl2sdk.git hl2sdk-cs2

      # 修复：克隆 manifests
      - name: Clone Manifests
        run: |
          git clone --branch master --depth 1 https://github.com/alliedmodders/hl2sdk-manifests.git hl2sdk-manifests

      # 验证克隆结果
      - name: Verify Dependencies
        run: |
          echo "=== Dependencies Status ==="
          echo "Metamod-Source: $(ls -la mmsource-2.0/ 2>/dev/null | head -1 || echo 'NOT FOUND')"
          echo "HL2SDK: $(ls -la hl2sdk-cs2/ 2>/dev/null | head -1 || echo 'NOT FOUND')"
          echo "Manifests: $(ls -la hl2sdk-manifests/ 2>/dev/null | head -1 || echo 'NOT FOUND')"

      # 设置环境变量
      - name: Set Environment
        run: |
          echo "HL2SDKCS2=${{ github.workspace }}/hl2sdk-cs2" >> $GITHUB_ENV
          echo "MMSOURCE112=${{ github.workspace }}/mmsource-2.0" >> $GITHUB_ENV

      # 安装构建依赖
      - name: Install Build Dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc-multilib g++-multilib

      - name: Install Build Dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          # 确保 VS Build Tools 可用
          echo "Windows build tools should be pre-installed"

      # 生成项目文件 - 关键步骤
      - name: Generate Project Files
        run: |
          echo "=== Generating Project Files ==="
          echo "Current directory: $(pwd)"
          echo "Directory contents:"
          ls -la
          
          echo "Running premake5..."
          if [ "${{ runner.os }}" == "Windows" ]; then
            C:/tools/premake5/premake5.exe vs2022
          else
            premake5 gmake2 --os=linux64
          fi
          
          echo "Build directory contents:"
          ls -la build/ 2>/dev/null || echo "Build directory not created"

      # 构建项目
      - name: Build Project (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "Building on Linux..."
          if [ ! -d "build" ]; then
            echo "ERROR: Build directory missing, regenerating..."
            premake5 gmake2 --os=linux64
          fi
          make -j$(nproc) -C build config=release_x86_64
          
          echo "Build output:"
          find bin/ -type f 2>/dev/null || echo "No build output"

      - name: Build Project (Windows)
        if: runner.os == 'Windows'
        run: |
          echo "Building on Windows..."
          if (!(Test-Path "build")) {
            echo "ERROR: Build directory missing, regenerating..."
            C:/tools/premake5/premake5.exe vs2022
          }
          
          # 使用 VS Build Tools
          "C:\Program Files\Microsoft Visual Studio\2022\BuildTools\MSBuild\Current\Bin\MSBuild.exe" `
            build/StripperCS2.sln `
            /p:Configuration=Release `
            /p:Platform=x64 `
            /p:PlatformToolset=v143 `
            /m `
            /v:minimal
          
          echo "Build output:"
          Get-ChildItem -Path bin -Recurse -ErrorAction SilentlyContinue | ForEach-Object { $_.FullName }

      # 上传制品
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: StripperCS2-${{ matrix.target }}
          path: |
            bin/**/*.dll
            bin/**/*.so
          retention-days: 30

      # 最终状态报告（简化版）
      - name: Final Report
        if: always()
        run: |
          echo "=== Build Final Report ==="
          echo "Dependencies:"
          echo "  Metamod: $(test -d mmsource-2.0 && echo '✓' || echo '✗')"
          echo "  HL2SDK: $(test -d hl2sdk-cs2 && echo '✓' || echo '✗')"
          echo "  Manifests: $(test -d hl2sdk-manifests && echo '✓' || echo '✗')"
          echo "Build:"
          echo "  Build dir: $(test -d build && echo '✓' || echo '✗')"
          echo "  Bin dir: $(test -d bin && echo '✓' || echo '✗')"
          if [ -d "bin" ]; then
            echo "Built files:"
            find bin/ -type f 2>/dev/null | while read file; do echo "  - $file"; done || echo "  No files"
          fi
