name: Build StripperCS2

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        include:
          - os: ubuntu-latest
            target: linux64
            artifact_name: libStripperCS2.so
          - os: windows-latest
            target: win64
            artifact_name: StripperCS2.dll

    steps:
      - name: Checkout StripperCS2
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Checkout Metamod-Source
        uses: actions/checkout@v4
        with:
          repository: alliedmodders/metamod-source
          ref: master
          path: mmsource-2.0
          submodules: recursive

      - name: Install Linux Dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc-multilib g++-multilib lib32z1

      - name: Install Windows Dependencies
        if: runner.os == 'Windows'
        run: |
          choco install visualstudio2022buildtools -y --force --package-parameters "--add Microsoft.VisualStudio.Workload.VCTools --includeRecommended --includeOptional --quiet"

      # 简化 Premake5 下载 - 使用 GitHub Action
      - name: Setup Premake5
        uses: BrokenAdmin/premake5-github-action@v1
        with:
          version: 5.0.0-beta2

      # 修复 HL2SDK 克隆 - 使用更简单的方法
      - name: Clone HL2SDKCS2
        run: |
          echo "Cloning HL2SDK for CS2..."
          git clone https://github.com/alliedmodders/hl2sdk.git hl2sdk-cs2
          cd hl2sdk-cs2
          # 使用最新的 CS2 SDK 提交
          git checkout da981a8984c74641d2a31732a0bac742bfea6e2d
          echo "HL2SDKCS2 cloned successfully"

      # 修复 manifests 克隆
      - name: Clone HL2SDK Manifests
        run: |
          echo "Cloning hl2sdk-manifests..."
          git clone https://github.com/alliedmodders/hl2sdk-manifests.git hl2sdk-manifests
          cd hl2sdk-manifests
          git checkout f9558bcc764598cb94c676ea0d0d3870a9b40353
          echo "HL2SDK manifests cloned successfully"

      # 验证依赖项
      - name: Verify Dependencies
        run: |
          echo "=== Verifying Dependencies ==="
          echo "Current directory: $(pwd)"
          echo "Contents:"
          ls -la
          echo "--- HL2SDKCS2 ---"
          ls -la hl2sdk-cs2/ 2>/dev/null | head -5 || echo "HL2SDKCS2 not found"
          echo "--- MMSOURCE112 ---"
          ls -la mmsource-2.0/ 2>/dev/null | head -5 || echo "MMSOURCE112 not found"
          echo "--- Manifests ---"
          ls -la hl2sdk-manifests/ 2>/dev/null | head -5 || echo "Manifests not found"

      # 设置环境变量
      - name: Set Environment Variables
        run: |
          echo "HL2SDKCS2=${{ github.workspace }}/hl2sdk-cs2" >> $GITHUB_ENV
          echo "MMSOURCE112=${{ github.workspace }}/mmsource-2.0" >> $GITHUB_ENV
          echo "HL2SDK_MANIFESTS=${{ github.workspace }}/hl2sdk-manifests" >> $GITHUB_ENV

      # 生成项目文件 - 简化版本
      - name: Generate Project Files
        run: |
          echo "=== Generating project files ==="
          echo "Current directory: $(pwd)"
          echo "Environment variables:"
          echo "HL2SDKCS2: $HL2SDKCS2"
          echo "MMSOURCE112: $MMSOURCE112"
          echo "HL2SDK_MANIFESTS: $HL2SDK_MANIFESTS"
          
          # 检查关键目录
          echo "Checking directories..."
          [ -d "$HL2SDKCS2" ] && echo "✓ HL2SDKCS2 exists" || echo "✗ HL2SDKCS2 missing"
          [ -d "$MMSOURCE112" ] && echo "✓ MMSOURCE112 exists" || echo "✗ MMSOURCE112 missing"
          [ -d "$HL2SDK_MANIFESTS" ] && echo "✓ Manifests exist" || echo "✗ Manifests missing"
          
          # 列出 manifests 内容
          echo "Manifests contents:"
          ls -la "$HL2SDK_MANIFESTS" || echo "Cannot list manifests"
          
          echo "Running premake5..."
          if [ "${{ runner.os }}" = "Windows" ]; then
            premake5 vs2022 --hl2sdk-root=hl2sdk-manifests
          else
            premake5 gmake2 --os=linux64 --hl2sdk-root=hl2sdk-manifests
          fi
          
          echo "Checking if build directory was created..."
          ls -la build/ 2>/dev/null && echo "✓ Build directory created" || echo "✗ Build directory not created"

      - name: Build Project (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "Building on Linux..."
          # 先检查 build 目录是否存在
          if [ ! -d "build" ]; then
            echo "ERROR: build directory does not exist!"
            echo "Trying to generate project files again..."
            premake5 gmake2 --os=linux64 --hl2sdk-root=hl2sdk-manifests
          fi
          
          make -j$(nproc) -C build config=release_x86_64
          echo "=== Build Output ==="
          find bin/ -type f 2>/dev/null || echo "No build output found"

      - name: Build Project (Windows)
        if: runner.os == 'Windows'
        run: |
          echo "Building on Windows..."
          # 先检查 build 目录是否存在
          if (!(Test-Path "build")) {
            echo "ERROR: build directory does not exist!"
            echo "Trying to generate project files again..."
            premake5 vs2022 --hl2sdk-root=hl2sdk-manifests
          }
          
          # 使用 MSBuild
          "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\MSBuild.exe" `
            build/StripperCS2.sln `
            /p:Configuration=Release `
            /p:Platform=x64 `
            /p:PlatformToolset=v143 `
            /m `
            /v:minimal
          
          echo "=== Build Output ==="
          Get-ChildItem -Path bin -Recurse -ErrorAction SilentlyContinue | Select-Object Name, FullName

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: StripperCS2-${{ matrix.target }}
          path: |
            bin/**/*.dll
            bin/**/*.so
          retention-days: 30

      # 简化的调试信息 - 避免错误
      - name: Final Status Check
        if: always()
        run: |
          echo "=== Build Status Check ==="
          echo "HL2SDKCS2: $(test -d hl2sdk-cs2 && echo 'OK' || echo 'MISSING')"
          echo "MMSOURCE112: $(test -d mmsource-2.0 && echo 'OK' || echo 'MISSING')"
          echo "Manifests: $(test -d hl2sdk-manifests && echo 'OK' || echo 'MISSING')"
          echo "Build dir: $(test -d build && echo 'OK' || echo 'MISSING')"
          echo "Bin dir: $(test -d bin && echo 'OK' || echo 'MISSING')"
          if [ -d "bin" ]; then
            echo "Bin contents:"
            find bin/ -type f 2>/dev/null || echo "No files in bin"
          fi
