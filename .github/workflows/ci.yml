name: Build StripperCS2

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

env:
  HL2SDKCS2: ${{ github.workspace }}/hl2sdk-cs2
  MMSOURCE112: ${{ github.workspace }}/mmsource-2.0

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        include:
          - os: ubuntu-latest
            target: linux64
            sdk_branch: 84a823db042b49d2f6934b770dafbf3a366cef26
            mm_repo: alliedmodders/metamod-source
            mm_ref: master
            premake_os: linux
            artifact_name: libStripperCS2.so
          - os: windows-latest
            target: win64
            sdk_branch: 84a823db042b49d2f6934b770dafbf3a366cef26
            mm_repo: alliedmodders/metamod-source
            mm_ref: master
            premake_os: windows
            artifact_name: StripperCS2.dll

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Linux Dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc-multilib g++-multilib lib32z1

      - name: Install Windows Dependencies
        if: runner.os == 'Windows'
        run: |
          choco install visualstudio2022buildtools -y
          choco install visualstudio2022-workload-vctools -y

      # 简化 Premake5 下载
      - name: Download Premake5
        run: |
          if [ "${{ runner.os }}" = "Windows" ]; then
            curl -L -o premake5.zip https://github.com/premake/premake-core/releases/download/v5.0.0-beta2/premake-5.0.0-beta2-windows.zip
            unzip premake5.zip
            mv premake5.exe /usr/local/bin/premake5.exe
          else
            curl -L -o premake5.tar.gz https://github.com/premake/premake-core/releases/download/v5.0.0-beta2/premake-5.0.0-beta2-linux.tar.gz
            tar -xzf premake5.tar.gz
            mv premake5 /usr/local/bin/premake5
            chmod +x /usr/local/bin/premake5
          fi

      - name: Clone HL2SDKCS2
        run: |
          git clone --branch ${{ matrix.sdk_branch }} https://github.com/alliedmodders/hl2sdk.git $HL2SDKCS2

      - name: Clone Metamod:Source
        run: |
          git clone --recursive --branch ${{ matrix.mm_ref }} https://github.com/${{ matrix.mm_repo }}.git $MMSOURCE112

      # 构建依赖库
      - name: Build Dependencies
        run: |
          echo "Building dependencies..."
          # 确保 vendor 目录存在
          mkdir -p vendor
          
          # 这里需要根据项目的实际依赖构建流程来补充
          # 由于项目包含 vendor/pcre 和 premake/spdlog，可能需要先构建这些

      # 为不同平台使用不同的 Premake 参数
      - name: Generate Project Files
        run: |
          if [ "${{ runner.os }}" = "Windows" ]; then
            premake5 vs2022
          else
            premake5 gmake2
          fi

      - name: Build Project (Linux)
        if: runner.os == 'Linux'
        run: |
          make -j$(nproc) -C build config=release_x86_64
          ls -la bin/

      - name: Build Project (Windows)
        if: runner.os == 'Windows'
        run: |
          # 使用正确的 MSBuild 路径
          "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\MSBuild.exe" ^
            /p:Configuration=Release ^
            /p:Platform=x64 ^
            /p:PlatformToolset=v143 ^
            /m ^
            /v:minimal ^
            build/StripperCS2.sln

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: StripperCS2-${{ matrix.target }}
          path: |
            bin/**/*.dll
            bin/**/*.so
          retention-days: 30

      - name: Debug Info
        if: always()
        run: |
          echo "=== Environment Variables ==="
          echo "HL2SDKCS2: $HL2SDKCS2"
          echo "MMSOURCE112: $MMSOURCE112"
          echo "=== Directory Structure ==="
          ls -la
          echo "=== Bin Contents ==="
          find bin/ -type f 2>/dev/null || echo "No bin directory"
          echo "=== Build Contents ==="
          find build/ -type f 2>/dev/null || echo "No build directory"
