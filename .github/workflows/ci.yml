name: Build StripperCS2

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

env:
  HL2SDKCS2: ${{ github.workspace }}/hl2sdk-cs2
  MMSOURCE112: ${{ github.workspace }}/mmsource-2.0

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        include:
          - os: ubuntu-latest
            target: linux64
            sdk_branch: 84a823db042b49d2f6934b770dafbf3a366cef26
            mm_repo: alliedmodders/metamod-source
            mm_ref: master
            artifact_name: libStripperCS2.so
          - os: windows-latest
            target: win64
            sdk_branch: 84a823db042b49d2f6934b770dafbf3a366cef26
            mm_repo: alliedmodders/metamod-source
            mm_ref: master
            artifact_name: StripperCS2.dll

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Linux Dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc-multilib g++-multilib lib32z1

      - name: Install Windows Dependencies
        if: runner.os == 'Windows'
        run: |
          # 安装 Visual Studio Build Tools
          choco install visualstudio2022buildtools -y --package-parameters "--add Microsoft.VisualStudio.Workload.VCTools --includeRecommended --includeOptional --quiet"

      # 简化 Premake5 下载 - 分别处理不同平台
      - name: Download Premake5 (Linux)
        if: runner.os == 'Linux'
        run: |
          curl -L -o premake5.tar.gz https://github.com/premake/premake-core/releases/download/v5.0.0-beta2/premake-5.0.0-beta2-linux.tar.gz
          tar -xzf premake5.tar.gz
          sudo mv premake5 /usr/local/bin/
          sudo chmod +x /usr/local/bin/premake5
          premake5 --version

      - name: Download Premake5 (Windows)
        if: runner.os == 'Windows'
        run: |
          curl -L -o premake5.zip https://github.com/premake/premake-core/releases/download/v5.0.0-beta2/premake-5.0.0-beta2-windows.zip
          unzip -o premake5.zip
          mkdir -p C:/tools/premake5
          move premake5.exe C:/tools/premake5/
          echo "C:/tools/premake5" >> $GITHUB_PATH

      - name: Verify Premake5
        run: |
          premake5 --version

      - name: Clone HL2SDKCS2
        run: |
          git clone --branch ${{ matrix.sdk_branch }} --depth 1 https://github.com/alliedmodders/hl2sdk.git $HL2SDKCS2

      - name: Clone Metamod:Source
        run: |
          git clone --branch ${{ matrix.mm_ref }} --depth 1 --recursive https://github.com/${{ matrix.mm_repo }}.git $MMSOURCE112

      # 设置环境变量（Windows 需要特殊处理）
      - name: Setup Environment (Windows)
        if: runner.os == 'Windows'
        run: |
          echo "HL2SDKCS2=$env:HL2SDKCS2"
          echo "MMSOURCE112=$env:MMSOURCE112"
          # 设置 VS 环境变量
          echo "VS160COMNTOOLS=C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\" >> $env:GITHUB_ENV

      - name: Generate Project Files
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
            premake5 vs2022
          else
            premake5 gmake2 --os=linux64
          fi

      - name: Build Project (Linux)
        if: runner.os == 'Linux'
        run: |
          make -j$(nproc) -C build config=release_x86_64
          echo "=== Build Output ==="
          find bin/ -type f -name "*.so" 2>/dev/null || echo "No .so files found"

      - name: Build Project (Windows)
        if: runner.os == 'Windows'
        run: |
          # 使用 Developer Command Prompt 设置环境
          "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\VsDevCmd.bat" -arch=x64 && ^
          msbuild.exe ^
            build/StripperCS2.sln ^
            /p:Configuration=Release ^
            /p:Platform=x64 ^
            /p:PlatformToolset=v143 ^
            /m ^
            /v:minimal ^
            /p:WindowsTargetPlatformVersion=10.0
          
          echo "=== Build Output ==="
          dir bin\ /s 2>nul || echo "No bin directory"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: StripperCS2-${{ matrix.target }}
          path: |
            bin/**/*.dll
            bin/**/*.so
          retention-days: 30

      # 修复调试信息 - 分别处理不同平台
      - name: Debug Info (Linux)
        if: runner.os == 'Linux' && always()
        run: |
          echo "=== Environment Variables ==="
          echo "HL2SDKCS2: $HL2SDKCS2"
          echo "MMSOURCE112: $MMSOURCE112"
          echo "=== Directory Structure ==="
          ls -la
          echo "=== HL2SDKCS2 Contents ==="
          ls -la "$HL2SDKCS2" 2>/dev/null || echo "HL2SDKCS2 directory not found"
          echo "=== MMSOURCE112 Contents ==="
          ls -la "$MMSOURCE112" 2>/dev/null || echo "MMSOURCE112 directory not found"
          echo "=== Bin Contents ==="
          find bin/ -type f 2>/dev/null || echo "No bin directory"
          echo "=== Build Contents ==="
          find build/ -type f 2>/dev/null || echo "No build directory"

      - name: Debug Info (Windows)
        if: runner.os == 'Windows' && always()
        run: |
          echo "=== Environment Variables ==="
          echo "HL2SDKCS2: $env:HL2SDKCS2"
          echo "MMSOURCE112: $env:MMSOURCE112"
          echo "=== Directory Structure ==="
          dir
          echo "=== HL2SDKCS2 Contents ==="
          dir "$env:HL2SDKCS2" 2>nul || echo "HL2SDKCS2 directory not found"
          echo "=== MMSOURCE112 Contents ==="
          dir "$env:MMSOURCE112" 2>nul || echo "MMSOURCE112 directory not found"
          echo "=== Bin Contents ==="
          dir bin\ /s 2>nul || echo "No bin directory"
          echo "=== Build Contents ==="
          dir build\ /s 2>nul || echo "No build directory"
