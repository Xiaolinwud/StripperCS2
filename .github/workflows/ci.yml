name: Build StripperCS2

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        include:
          - os: ubuntu-latest
            target: linux64
            sdk_branch: cs2
            mm_repo: alliedmodders/metamod-source
            mm_ref: master
            artifact_name: libStripperCS2.so
          - os: windows-latest
            target: win64
            sdk_branch: cs2
            mm_repo: alliedmodders/metamod-source
            mm_ref: master
            artifact_name: StripperCS2.dll

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Linux Dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc-multilib g++-multilib lib32z1

      - name: Install Windows Dependencies
        if: runner.os == 'Windows'
        run: |
          # 安装 Visual Studio Build Tools
          choco install visualstudio2022buildtools -y --package-parameters "--add Microsoft.VisualStudio.Workload.VCTools --includeRecommended --includeOptional --quiet"

      # 下载 Premake5
      - name: Download Premake5 (Linux)
        if: runner.os == 'Linux'
        run: |
          curl -L -o premake5.tar.gz https://github.com/premake/premake-core/releases/download/v5.0.0-beta2/premake-5.0.0-beta2-linux.tar.gz
          tar -xzf premake5.tar.gz
          sudo mv premake5 /usr/local/bin/
          sudo chmod +x /usr/local/bin/premake5
          premake5 --version

      - name: Download Premake5 (Windows)
        if: runner.os == 'Windows'
        run: |
          curl -L -o premake5.zip https://github.com/premake/premake-core/releases/download/v5.0.0-beta2/premake-5.0.0-beta2-windows.zip
          unzip -o premake5.zip
          mkdir -p C:/tools/premake5
          move premake5.exe C:/tools/premake5/
          echo "C:/tools/premake5" >> $GITHUB_PATH

      - name: Verify Premake5
        run: |
          premake5 --version

      # 修复 HL2SDK 克隆 - 使用正确的仓库和分支
      - name: Clone HL2SDKCS2
        run: |
          echo "Cloning HL2SDK for CS2..."
          git clone --branch ${{ matrix.sdk_branch }} --depth 1 https://github.com/alliedmodders/hl2sdk.git hl2sdk-cs2
          echo "HL2SDK cloned successfully"
          echo "HL2SDKCS2=${{ github.workspace }}/hl2sdk-cs2" >> $GITHUB_ENV

      # 修复 Metamod-Source 克隆
      - name: Clone Metamod:Source
        run: |
          echo "Cloning Metamod:Source..."
          git clone --branch ${{ matrix.mm_ref }} --depth 1 --recursive https://github.com/${{ matrix.mm_repo }}.git mmsource-2.0
          echo "Metamod:Source cloned successfully"
          echo "MMSOURCE112=${{ github.workspace }}/mmsource-2.0" >> $GITHUB_ENV

      # 验证克隆结果
      - name: Verify Dependencies
        run: |
          echo "=== Verifying Dependencies ==="
          if [ "${{ runner.os }}" == "Windows" ]; then
            echo "HL2SDKCS2: $env:HL2SDKCS2"
            echo "MMSOURCE112: $env:MMSOURCE112"
            dir hl2sdk-cs2 2>nul && echo "HL2SDK found" || echo "HL2SDK not found"
            dir mmsource-2.0 2>nul && echo "Metamod found" || echo "Metamod not found"
          else
            echo "HL2SDKCS2: $HL2SDKCS2"
            echo "MMSOURCE112: $MMSOURCE112"
            ls -la hl2sdk-cs2 2>/dev/null && echo "HL2SDK found" || echo "HL2SDK not found"
            ls -la mmsource-2.0 2>/dev/null && echo "Metamod found" || echo "Metamod not found"
          fi

      # 设置环境变量（Windows 需要特殊处理）
      - name: Setup Environment (Windows)
        if: runner.os == 'Windows'
        run: |
          echo "Setting up VS environment..."
          "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\VsDevCmd.bat" -arch=x64

      - name: Generate Project Files
        run: |
          echo "Generating project files..."
          echo "HL2SDKCS2: $HL2SDKCS2"
          echo "MMSOURCE112: $MMSOURCE112"
          
          if [ "${{ runner.os }}" == "Windows" ]; then
            premake5 vs2022
          else
            premake5 gmake2 --os=linux64
          fi
          
          echo "Project files generated"

      - name: Build Project (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "Building on Linux..."
          make -j$(nproc) -C build config=release_x86_64
          echo "=== Build Output ==="
          find bin/ -type f -name "*.so" 2>/dev/null || echo "No .so files found"

      - name: Build Project (Windows)
        if: runner.os == 'Windows'
        run: |
          echo "Building on Windows..."
          # 使用 Developer Command Prompt 设置环境
          "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\VsDevCmd.bat" -arch=x64 && ^
          msbuild.exe ^
            build/StripperCS2.sln ^
            /p:Configuration=Release ^
            /p:Platform=x64 ^
            /p:PlatformToolset=v143 ^
            /m ^
            /v:minimal ^
            /p:WindowsTargetPlatformVersion=10.0
          
          echo "=== Build Output ==="
          dir bin\ /s 2>nul || echo "No bin directory"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: StripperCS2-${{ matrix.target }}
          path: |
            bin/**/*.dll
            bin/**/*.so
          retention-days: 30

      # 修复调试信息 - 分别处理不同平台
      - name: Debug Info (Linux)
        if: runner.os == 'Linux' && always()
        run: |
          echo "=== Environment Variables ==="
          echo "HL2SDKCS2: $HL2SDKCS2"
          echo "MMSOURCE112: $MMSOURCE112"
          echo "=== Directory Structure ==="
          ls -la
          echo "=== HL2SDKCS2 Contents ==="
          ls -la "hl2sdk-cs2/" 2>/dev/null || echo "HL2SDKCS2 directory not found"
          echo "=== MMSOURCE112 Contents ==="
          ls -la "mmsource-2.0/" 2>/dev/null || echo "MMSOURCE112 directory not found"
          echo "=== Bin Contents ==="
          find bin/ -type f 2>/dev/null || echo "No bin directory"
          echo "=== Build Contents ==="
          find build/ -type f 2>/dev/null || echo "No build directory"

      - name: Debug Info (Windows)
        if: runner.os == 'Windows' && always()
        run: |
          echo "=== Environment Variables ==="
          echo "HL2SDKCS2: $env:HL2SDKCS2"
          echo "MMSOURCE112: $env:MMSOURCE112"
          echo "=== Directory Structure ==="
          dir
          echo "=== HL2SDKCS2 Contents ==="
          dir "hl2sdk-cs2" 2>nul || echo "HL2SDKCS2 directory not found"
          echo "=== MMSOURCE112 Contents ==="
          dir "mmsource-2.0" 2>nul || echo "MMSOURCE112 directory not found"
          echo "=== Bin Contents ==="
          dir bin\ /s 2>nul || echo "No bin directory"
          echo "=== Build Contents ==="
          dir build\ /s 2>nul || echo "No build directory"
